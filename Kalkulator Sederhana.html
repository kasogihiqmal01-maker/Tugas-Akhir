<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Kalkulator JavaScript Live Result</title>

<style>
    :root {
        --brightness-level: 1;

        --bg-body: #222;
        --bg-kalkulator: #333;
        --bg-layar: #000;
        --text-layar: #0affc6;
        --preview-color: #27ffea;
        --btn-bg: #555;
        --btn-op: #0a84ff;
        --btn-clear: #ff3b30;
        --btn-equal: #34c759;
        --history-bg: #333;
        --history-item-bg: #111;
        --text-color: white;
        --panel-bg: #333;
    }

    body.light {
        --bg-body: #f3f3f3;
        --bg-kalkulator: #ffffff;
        --bg-layar: #e8e8e8;
        --text-layar: #008b74;
        --preview-color: #005f4f;
        --btn-bg: #d4d4d4;
        --btn-op: #0077ff;
        --btn-clear: #ff4d4d;
        --btn-equal: #00c853;
        --history-bg: #ffffff;
        --history-item-bg: #e3e3e3;
        --text-color: #000;
        --panel-bg: #e1e1e1;
    }

    body {
        font-family: Arial, sans-serif;
        background: var(--bg-body);
        color: var(--text-color);
        display: flex;
        justify-content: center;
        padding: 40px;
        gap: 25px;
        filter: brightness(var(--brightness-level));
        transition: 0.3s ease;
    }

    .panel-setting {
        width: 230px;
        background: var(--panel-bg);
        padding: 15px;
        border-radius: 12px;
        height: fit-content;
    }

    .kontras-box {
        background: #444;
        padding: 12px;
        border-radius: 10px;
        margin-bottom: 15px;
    }
    body.light .kontras-box {
        background: #ccc;
    }

    .toggle-theme {
        margin-top: 10px;
        padding: 12px;
        width: 100%;
        border-radius: 10px;
        border: none;
        background: #00aaff;
        color: white;
        cursor: pointer;
        font-size: 16px;
    }

    .kalkulator {
        background: var(--bg-kalkulator);
        padding: 20px;
        width: 320px;
        border-radius: 20px;
    }

    .layar {
        background: var(--bg-layar);
        color: var(--text-layar);
        font-size: 24px;
        text-align: right;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 15px;
        min-height: 70px;
        overflow-x: auto;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
    }

    #expression {
        outline: none;
        white-space: nowrap;
        cursor: text;
    }

    .layar .expression {
        font-size: 24px;
    }
    .layar .preview {
        color: var(--preview-color);
        font-size: 18px;
    }

    button {
        padding: 18px;
        font-size: 20px;
        border: none;
        border-radius: 12px;
        background: var(--btn-bg);
        color: var(--text-color);
        cursor: pointer;
    }

    .operator { background: var(--btn-op); }
    .clear { background: var(--btn-clear); }
    .equal { background: var(--btn-equal); }
    .trig { background: #ff9500; }

    .tombol-container {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
    }

    .fx-container {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
        margin-top: 10px;
    }

    .history-box {
        background: var(--history-bg);
        width: 230px;
        padding: 15px;
        border-radius: 12px;
        max-height: 400px;
        overflow-y: auto;
    }

    .history-item {
        background: var(--history-item-bg);
        padding: 8px;
        margin-bottom: 10px;
        border-radius: 8px;
        font-size: 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .hapus-btn {
        background: var(--btn-clear);
        border: none;
        padding: 5px 8px;
        border-radius: 6px;
        cursor: pointer;
    }
</style>
</head>

<body>

<div class="panel-setting">
    <h3>Pengaturan Tampilan</h3>

    <div class="kontras-box">
        <label>Kecerahan: <span id="persenText">100%</span></label>
        <input type="range" id="kontrasRange" min="0" max="100" step="1" value="100">
    </div>

    <button class="toggle-theme" id="toggleTheme"> Dark / Light </button>
</div>

<div class="kalkulator">
    <h2 style="text-align:center;">Kalkulator Sederhana</h2>

    <div class="layar" id="layar">
        <div class="expression" id="expression" contenteditable="true"></div>
        <div class="preview" id="preview"></div>
    </div>

    <div class="tombol-container">
        <button class="clear" data-value="C">C</button>
        <button class="clear" data-value="DEL">DEL</button>
        <button data-value="(">(</button>
        <button class="operator" data-value=")">)</button>

        <button class="trig" data-value="sin(">sin</button>
        <button class="trig" data-value="cos(">cos</button>
        <button class="trig" data-value="tan(">tan</button>
        <button class="operator" data-value="/">÷</button>

        <button data-value="7">7</button>
        <button data-value="8">8</button>
        <button data-value="9">9</button>
        <button class="operator" data-value="*">×</button>

        <button data-value="4">4</button>
        <button data-value="5">5</button>
        <button data-value="6">6</button>
        <button class="operator" data-value="-">−</button>

        <button data-value="1">1</button>
        <button data-value="2">2</button>
        <button data-value="3">3</button>
        <button class="operator" data-value="+">+</button>

        <button data-value="0">0</button>
        <button data-value=".">.</button>
        <button class="equal" data-value="=">=</button>
        <button class="operator" data-value="pi">π</button>
    </div>

    <div class="fx-container">
        <button class="trig" data-value="log(">log</button>
        <button class="trig" data-value="ln(">ln</button>
        <button class="trig" data-value="sqrt(">√</button>
        <button class="operator" data-value="^">^</button>
    </div>
</div>

<div class="history-box">
    <h3 style="text-align:center;">Riwayat</h3>
    <div id="historyList"></div>
    <button id="hapusAll" style="background:#ff3b30; padding:10px; border-radius:10px; margin-top:5px; display:none;">Hapus Semua</button>
</div>

<script>
let hasil = "";
let preview = "";
let history = JSON.parse(localStorage.getItem('history')) || [];

const expressionEl = document.getElementById('expression');
const previewEl = document.getElementById('preview');
const historyListEl = document.getElementById('historyList');
const hapusAllBtn = document.getElementById('hapusAll');

function isValidExpression(str) {
    let openParen = 0;
    let inFunction = false;
    for (let i = 0; i < str.length; i++) {
        if (str[i] === '(') openParen++;
        if (str[i] === ')') openParen--;
        if (openParen < 0) return false;
        if (str.substr(i, 4) === 'sin(' || str.substr(i, 4) === 'cos(' || str.substr(i, 4) === 'tan(' || str.substr(i, 4) === 'log(' || str.substr(i, 3) === 'ln(' || str.substr(i, 5) === 'sqrt(') inFunction = true;
        if (inFunction && str[i] === ')') inFunction = false;
    }
    return openParen === 0 && !inFunction;
}

function updateDisplay() {
    expressionEl.textContent = hasil
        .replace(/\*/g, '×')
        .replace(/\//g, '÷')
        .replace(/Math\.sin\(/g, 'sin(')
        .replace(/Math\.cos\(/g, 'cos(')
        .replace(/Math\.tan\(/g, 'tan(')
        .replace(/Math\.log10\(/g, 'log(')
        .replace(/Math\.log\(/g, 'ln(')
        .replace(/Math\.sqrt\(/g, '√(')
        .replace(/\*\*/g, '^')
        .replace(/Math\.PI/g, 'π');
    previewEl.textContent = (preview !== "" && hasil !== "") ? "= " + preview : "";
}

expressionEl.addEventListener("input", () => {
    hasil = expressionEl.textContent
        .replace(/×/g, '*')
        .replace(/÷/g, '/')
        .replace(/sin\(/g, 'Math.sin(')
        .replace(/cos\(/g, 'Math.cos(')
        .replace(/tan\(/g, 'Math.tan(')
        .replace(/log\(/g, 'Math.log10(')
        .replace(/ln\(/g, 'Math.log(')
        .replace(/√\(/g, 'Math.sqrt(')
        .replace(/\^/g, '**')
        .replace(/π/g, 'Math.PI');
    calculatePreview();
});

expressionEl.addEventListener("keypress", (e) => {
    const allowed = "0123456789+-*/().";
    if (!allowed.includes(e.key)) e.preventDefault();
});

function calculatePreview() {
    if (hasil !== "" && /[0-9)\s]$/.test(hasil)) {
        let evalStr = hasil
            .replace(/sin\(/g, 'Math.sin(')
            .replace(/cos\(/g, 'Math.cos(')
            .replace(/tan\(/g, 'Math.tan(')
            .replace(/log\(/g, 'Math.log10(')
            .replace(/ln\(/g, 'Math.log(')
            .replace(/√\(/g, 'Math.sqrt(')
            .replace(/\^/g, '**')
            .replace(/π/g, 'Math.PI');
        if (isValidExpression(evalStr)) {
            try {
                preview = eval(evalStr);
            } catch {
                preview = "";
            }
        } else {
            preview = "";
        }
    } else {
        preview = "";
    }
    updateDisplay();
}

function handleButton(value) {
    if (value === "C") {
        hasil = "";
        preview = "";
        expressionEl.textContent = "";
    }
    else if (value === "DEL") {
        hasil = hasil.slice(0, -1);
    }
    else if (value === "=") {
        let evalStr = hasil
            .replace(/sin\(/g, 'Math.sin(')
            .replace(/cos\(/g, 'Math.cos(')
            .replace(/tan\(/g, 'Math.tan(')
            .replace(/log\(/g, 'Math.log10(')
            .replace(/ln\(/g, 'Math.log(')
            .replace(/√\(/g, 'Math.sqrt(')
            .replace(/\^/g, '**')
            .replace(/π/g, 'Math.PI');
        if (isValidExpression(evalStr)) {
            try {
                const result = eval(evalStr);
                const riwayat = hasil
                    .replace(/\*/g, '×')
                    .replace(/\//g, '÷')
                    .replace(/Math\.sin\(/g, 'sin(')
                    .replace(/Math\.cos\(/g, 'cos(')
                    .replace(/Math\.tan\(/g, 'tan(')
                    .replace(/Math\.log10\(/g, 'log(')
                    .replace(/Math\.log\(/g, 'ln(')
                    .replace(/Math\.sqrt\(/g, '√(')
                    .replace(/\*\*/g, '^')
                    .replace(/Math\.PI/g, 'π') + " = " + result;
                history.push(riwayat);
                localStorage.setItem('history', JSON.stringify(history));
                hasil = result.toString();
                preview = "";
                renderHistory();
            } catch {
                hasil = "Error";
                preview = "";
            }
        } else {
            hasil = "Error";
            preview = "";
        }
    }
    else {
        hasil += value;
    }

    calculatePreview();
}

document.querySelectorAll('.tombol-container button').forEach(btn => {
    btn.addEventListener('click', () => handleButton(btn.getAttribute('data-value')));
});

document.addEventListener('keydown', (e) => {
    const allowedKeys = '0123456789+-*/().';

    if (allowedKeys.includes(e.key)) {
        if (e.key === '5' && hasil.endsWith('4')) {
            hasil += '9' + e.key;
        } else {
            hasil += e.key;
        }
        calculatePreview();
        e.stopPropagation();
    }

    if (e.key === "Enter") { e.preventDefault(); handleButton("="); e.stopPropagation(); }
    if (e.key === "Backspace") { handleButton("DEL"); e.stopPropagation(); }
    if (e.key === "Escape") { handleButton("C"); e.stopPropagation(); }

    if (e.key === "ArrowUp") {
        document.body.classList.add("light");
        localStorage.setItem("themeMode", "light");
        e.stopPropagation();
    }
    if (e.key === "ArrowDown") {
        document.body.classList.remove("light");
        localStorage.setItem("themeMode", "dark");
        e.stopPropagation();
    }
});

function renderHistory() {
    historyListEl.innerHTML = '';

    if (history.length === 0) {
        historyListEl.innerHTML = '<p style="text-align:center; color:#bbb;">Belum ada riwayat</p>';
        hapusAllBtn.style.display = 'none';
    } else {
        history.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'history-item';
            div.innerHTML = `${item} <button class="hapus-btn" data-index="${index}">X</button>`;
            historyListEl.appendChild(div);
        });
        hapusAllBtn.style.display = 'block';
    }
}

historyListEl.addEventListener('click', (e) => {
    if (e.target.classList.contains('hapus-btn')) {
        const index = e.target.getAttribute('data-index');
        history.splice(index, 1);
        localStorage.setItem('history', JSON.stringify(history));
        renderHistory();
    }
});

hapusAllBtn.addEventListener('click', () => {
    history = [];
    localStorage.setItem('history', JSON.stringify(history));
    renderHistory();
});

const range = document.getElementById('kontrasRange');
const persenText = document.getElementById('persenText');

range.addEventListener('input', () => {
    const persen = range.value;
    persenText.textContent = persen + '%';
    const bright = (persen / 100) * 1.8;
    document.documentElement.style.setProperty('--brightness-level', bright);
    localStorage.setItem('brightnessPercent', persen);
});

const savedPercent = localStorage.getItem('brightnessPercent');
if (savedPercent) {
    range.value = savedPercent;
    persenText.textContent = savedPercent + '%';
    const bright = (savedPercent / 100) * 1.8;
    document.documentElement.style.setProperty('--brightness-level', bright);
}

const theme = localStorage.getItem('themeMode');
if (theme === 'light') document.body.classList.add('light');

renderHistory();
updateDisplay();
</script>

<script>
function handleButton(value) {
    if (value === "C") {
        hasil = "";
        preview = "";
        expressionEl.textContent = "";
    }
    else if (value === "DEL") {
        hasil = hasil.slice(0, -1);
    }
    else if (value === "=") {
        let evalStr = hasil
            .replace(/sin\(/g, 'Math.sin(')
            .replace(/cos\(/g, 'Math.cos(')
            .replace(/tan\(/g, 'Math.tan(')
            .replace(/log\(/g, 'Math.log10(')
            .replace(/ln\(/g, 'Math.log(')
            .replace(/√\(/g, 'Math.sqrt(')
            .replace(/\^/g, '**')
            .replace(/π/g, 'Math.PI');
        if (isValidExpression(evalStr)) {
            try {
                const result = eval(evalStr);
                const riwayat = hasil
                    .replace(/\*/g, '×')
                    .replace(/\//g, '÷')
                    .replace(/Math\.sin\(/g, 'sin(')
                    .replace(/Math\.cos\(/g, 'cos(')
                    .replace(/Math\.tan\(/g, 'tan(')
                    .replace(/Math\.log10\(/g, 'log(')
                    .replace(/Math\.log\(/g, 'ln(')
                    .replace(/Math\.sqrt\(/g, '√(')
                    .replace(/\*\*/g, '^')
                    .replace(/Math\.PI/g, 'π') + " = " + result;
                history.push(riwayat);
                localStorage.setItem('history', JSON.stringify(history));
                hasil = result.toString();
                preview = "";
                renderHistory();
            } catch {
                hasil = "Error";
                preview = "";
            }
        } else {
            hasil = "Error";
            preview = "";
        }
    }
    else {
        if (value === '5' && hasil.endsWith('4')) {
            hasil += '9' + value;
        } else {
            hasil += value;
        }
    }

    calculatePreview();
}

document.addEventListener('keydown', (e) => {
    const allowedKeys = '0123456789+-*/().';

    if (allowedKeys.includes(e.key)) {
        if (e.key === '5' && hasil.endsWith('4')) {
            hasil += '9' + e.key;
        } else {
            hasil += e.key;
        }
        calculatePreview();
        e.stopPropagation();
    }

    if (e.key === "Enter") { e.preventDefault(); handleButton("="); e.stopPropagation(); }
    if (e.key === "Backspace") { handleButton("DEL"); e.stopPropagation(); }
    if (e.key === "Escape") { handleButton("C"); e.stopPropagation(); }

    if (e.key === "ArrowUp") {
        document.body.classList.add("light");
        localStorage.setItem("themeMode", "light");
        e.stopPropagation();
    }
    if (e.key === "ArrowDown") {
        document.body.classList.remove("light");
        localStorage.setItem("themeMode", "dark");
        e.stopPropagation();
    }
}, true);
</script>

</body>
</html>
