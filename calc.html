<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Kalkulator JavaScript Live Result</title>

<style>
    :root {
        --brightness-level: 1;

        --bg-body: #020714;
        --bg-kalkulator: #0f143a;
        --bg-layar: #020714;
        --text-layar: #ffffff;
        --preview-color: #27ffea;
        --btn-bg: #2f365c;
        --btn-op: #0a84ff;
        --btn-clear: #ff3b30;
        --btn-equal: #34c759;
        --history-bg: #0f143a;
        --history-item-bg: #020714;
        --text-color: white;
        --panel-bg: #0f143a;

        /* Neumorphism shadows */
        --shadow-light: inset 5px 5px 10px rgba(255,255,255,0.1), inset -5px -5px 10px rgba(0,0,0,0.3);
        --shadow-dark: inset 5px 5px 10px rgba(0,0,0,0.3), inset -5px -5px 10px rgba(255,255,255,0.1);
        --shadow-raised: 8px 8px 16px rgba(0,0,0,0.3), -8px -8px 16px rgba(255,255,255,0.1);
        --shadow-pressed: inset 4px 4px 8px rgba(0,0,0,0.3), inset -4px -4px 8px rgba(255,255,255,0.1);
        --inner-shadow: inset 0 0 20px rgba(0,0,0,0.5);
    }

    body.light {
        --bg-body: #f1f5f9;
        --bg-kalkulator: #ffffff;
        --bg-layar: #e5e7eb;
        --text-layar: #0f172a;
        --preview-color: #475569;
        --btn-bg: #e5e7eb;
        --btn-op: #3b82f6;
        --btn-clear: #ef4444;
        --btn-equal: #22c55e;
        --history-bg: #ffffff;
        --history-item-bg: #f8fafc;
        --text-color: #0f172a;
        --panel-bg: #ffffff;
    }

    body {
        font-family: Arial, sans-serif;
        background: var(--bg-body);
        color: var(--text-color);
        display: flex;
        justify-content: center;
        padding: 40px;
        gap: 25px;
        filter: brightness(var(--brightness-level));
        transition: 0.3s ease;
        perspective: 1000px;
    }

    .panel-setting {
        width: 230px;
        background: var(--panel-bg);
        padding: 15px;
        border-radius: 12px;
        height: fit-content;
    }

    .kontras-box {
        background: #020714;
        padding: 12px;
        border-radius: 10px;
        margin-bottom: 15px;
    }
    body.light .kontras-box {
        background: #d4d4d4;
    }

    .toggle-theme {
        margin-top: 10px;
        padding: 12px;
        width: 100%;
        border-radius: 10px;
        border: none;
        background: #00aaff;
        color: rgb(255, 255, 255);
        cursor: pointer;
        font-size: 16px;
    }

    .kalkulator {
        background: var(--bg-kalkulator);
        padding: 20px;
        width: 320px;
        border-radius: 20px;
        box-shadow: 0 30px 60px rgba(0,0,0,0.4), 0 0 30px rgba(10,132,255,0.2);
    }

    body:not(.light) .kalkulator {
        box-shadow: 0 30px 60px rgba(0,0,0,0.4), 0 0 40px rgba(10,132,255,0.3), 0 0 80px rgba(10,132,255,0.1);
    }

    .layar {
        background: linear-gradient(145deg, var(--bg-layar), rgba(255,255,255,0.05));
        color: var(--text-layar);
        font-size: 24px;
        text-align: right;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 15px;
        min-height: 70px;
        overflow-x: auto;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        box-shadow: var(--inner-shadow);
        border: 1px solid rgba(255,255,255,0.1);
    }

    #expression {
        outline: none;
        white-space: nowrap;
        cursor: text;
    }

    .layar .expression {
        font-size: 24px;
    }
    .layar .preview {
        color: var(--preview-color);
        font-size: 18px;
    }

    button {
        padding: 18px;
        font-size: 20px;
        border: none;
        border-radius: 12px;
        background: linear-gradient(145deg, var(--btn-bg), rgba(255,255,255,0.1));
        color: var(--text-color);
        cursor: pointer;
        transform: translateZ(5px);
        box-shadow: var(--shadow-raised);
        transition: all 0.2s ease;
    }

    button:active {
        transform: translateZ(2px);
        box-shadow: var(--shadow-pressed);
        background: linear-gradient(145deg, rgba(0,0,0,0.1), var(--btn-bg));
    }

    .operator { background: var(--btn-op); }
    .clear { background: var(--btn-clear); }
    .equal { background: var(--btn-equal); }
    .trig { background: #ff9500; }

    .tombol-container {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
    }

    .fx-container {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
        margin-top: 10px;
    }

    .history-box {
        background: var(--history-bg);
        width: 230px;
        padding: 15px;
        border-radius: 12px;
        max-height: 400px;
        overflow-y: auto;
    }

    .history-item {
        background: var(--history-item-bg);
        padding: 8px;
        margin-bottom: 10px;
        border-radius: 8px;
        font-size: 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .hapus-btn {
        background: var(--btn-clear);
        border: none;
        padding: 5px 8px;
        border-radius: 6px;
        cursor: pointer;
        color: white;
    }

</style>
</head>

<body>

<div class="panel-setting">
    <h3>Pengaturan Tampilan</h3>

    <div class="kontras-box">
        <label>Kecerahan: <span id="persenText">100%</span></label>
        <input type="range" id="kontrasRange" min="0" max="100" step="1" value="100">
    </div>

    <button class="toggle-theme" id="toggleTheme"> Dark / Light </button>
</div>

<div class="kalkulator">
    <h2 style="text-align:center;">Kalkulator Sederhana</h2>

    <div class="layar" id="layar">
        <div class="expression" id="expression" contenteditable="true"></div>
        <div class="preview" id="preview"></div>
    </div>

    <div class="tombol-container">
        <button class="clear" data-value="C">C</button>
        <button class="clear" data-value="DEL">DEL</button>
        <button data-value="(">(</button>
        <button class="operator" data-value=")">)</button>

        <button class="trig" data-value="sin(">sin</button>
        <button class="trig" data-value="cos(">cos</button>
        <button class="trig" data-value="tan(">tan</button>
        <button class="operator" data-value="/">÷</button>

        <button data-value="7">7</button>
        <button data-value="8">8</button>
        <button data-value="9">9</button>
        <button class="operator" data-value="*">×</button>

        <button data-value="4">4</button>
        <button data-value="5">5</button>
        <button data-value="6">6</button>
        <button class="operator" data-value="-">−</button>

        <button data-value="1">1</button>
        <button data-value="2">2</button>
        <button data-value="3">3</button>
        <button class="operator" data-value="+">+</button>

        <button data-value="0">0</button>
        <button data-value=".">.</button>
        <button class="equal" data-value="=">=</button>
        <button class="operator" data-value="pi">π</button>
    </div>

    <div class="fx-container">
        <button class="trig" data-value="log(">log</button>
        <button class="trig" data-value="ln(">ln</button>
        <button class="trig" data-value="sqrt(">√</button>
        <button class="operator" data-value="^">^</button>
    </div>
</div>

<div class="history-box">
    <h3 style="text-align:center;">Riwayat</h3>
    <div id="historyList"></div>
    <button id="hapusAll" style="background:#ff3b30; padding:10px; border-radius:10px; margin-top:5px; display:none;">Hapus Semua</button>
</div>

<script>
let hasil = "";
let preview = "";
let history = JSON.parse(localStorage.getItem('history')) || [];

const expressionEl = document.getElementById('expression');
const previewEl = document.getElementById('preview');
const historyListEl = document.getElementById('historyList');
const hapusAllBtn = document.getElementById('hapusAll');

// Custom functions for degrees
function degSin(deg) {
    return Math.sin(deg * Math.PI / 180);
}

function degCos(deg) {
    return Math.cos(deg * Math.PI / 180);
}

function degTan(deg) {
    return Math.tan(deg * Math.PI / 180);
}

// Function to convert decimal to fraction
function toFraction(num) {
    if (Math.abs(num) < 1e-10) return "0";
    if (Math.abs(num - 1) < 1e-10) return "1";
    if (Math.abs(num + 1) < 1e-10) return "-1";
    if (Math.abs(num - 0.5) < 1e-10) return "1/2";
    if (Math.abs(num + 0.5) < 1e-10) return "-1/2";
    if (Math.abs(num - Math.sqrt(2)/2) < 1e-10) return "√2/2";
    if (Math.abs(num + Math.sqrt(2)/2) < 1e-10) return "-√2/2";
    if (Math.abs(num - Math.sqrt(3)/2) < 1e-10) return "√3/2";
    if (Math.abs(num + Math.sqrt(3)/2) < 1e-10) return "-√3/2";
    if (Math.abs(num - Math.sqrt(3)/3) < 1e-10) return "√3/3";
    if (Math.abs(num + Math.sqrt(3)/3) < 1e-10) return "-√3/3";
    if (Math.abs(num - 1/3) < 1e-10) return "1/3";
    if (Math.abs(num + 1/3) < 1e-10) return "-1/3";
    if (Math.abs(num - 2/3) < 1e-10) return "2/3";
    if (Math.abs(num + 2/3) < 1e-10) return "-2/3";
    if (Math.abs(num - 1/Math.sqrt(2)) < 1e-10) return "1/√2";
    if (Math.abs(num + 1/Math.sqrt(2)) < 1e-10) return "-1/√2";
    if (Math.abs(num - 1/Math.sqrt(3)) < 1e-10) return "1/√3";
    if (Math.abs(num + 1/Math.sqrt(3)) < 1e-10) return "-1/√3";
    // For other cases, return decimal
    return num.toString();
}

function isValidExpression(str) {
    let openParen = 0;
    let inFunction = false;
    for (let i = 0; i < str.length; i++) {
        if (str[i] === '(') openParen++;
        if (str[i] === ')') openParen--;
        if (openParen < 0) return false;
        if (str.substr(i, 4) === 'sin(' || str.substr(i, 4) === 'cos(' || str.substr(i, 4) === 'tan(' || str.substr(i, 4) === 'log(' || str.substr(i, 3) === 'ln(' || str.substr(i, 5) === 'sqrt(') inFunction = true;
        if (inFunction && str[i] === ')') inFunction = false;
    }
    return openParen === 0 && !inFunction;
}

function updateDisplay() {
    expressionEl.textContent = hasil
        .replace(/\*/g, '×')
        .replace(/\//g, '÷')
        .replace(/degSin\(/g, 'sin(')
        .replace(/degCos\(/g, 'cos(')
        .replace(/degTan\(/g, 'tan(')
        .replace(/Math\.log10\(/g, 'log(')
        .replace(/Math\.log\(/g, 'ln(')
        .replace(/Math\.sqrt\(/g, '√(')
        .replace(/\*\*/g, '^')
        .replace(/Math\.PI/g, 'π');
    previewEl.textContent = (preview !== "" && hasil !== "") ? "= " + preview : "";
    // Set cursor to the end
    const range = document.createRange();
    const sel = window.getSelection();
    range.selectNodeContents(expressionEl);
    range.collapse(false);
    sel.removeAllRanges();
    sel.addRange(range);
}

expressionEl.addEventListener("input", () => {
    hasil = expressionEl.textContent
        .replace(/×/g, '*')
        .replace(/÷/g, '/')
        .replace(/log\(/g, 'Math.log10(')
        .replace(/ln\(/g, 'Math.log(')
        .replace(/√\(/g, 'Math.sqrt(')
        .replace(/\^/g, '**')
        .replace(/π/g, 'Math.PI');
    calculatePreview();
});

expressionEl.addEventListener("keypress", (e) => {
    const allowed = "0123456789+-*/().";
    if (!allowed.includes(e.key)) e.preventDefault();
});

function calculatePreview() {
    if (hasil !== "" && /[0-9)\s]$/.test(hasil)) {
        let useDeg = hasil.includes(')');
        let evalStr = hasil
            .replace(/sin\(/g, useDeg ? 'degSin(' : 'Math.sin(')
            .replace(/cos\(/g, useDeg ? 'degCos(' : 'Math.cos(')
            .replace(/tan\(/g, useDeg ? 'degTan(' : 'Math.tan(')
            .replace(/log\(/g, 'Math.log10(')
            .replace(/ln\(/g, 'Math.log(')
            .replace(/√\(/g, 'Math.sqrt(')
            .replace(/\^/g, '**')
            .replace(/π/g, 'Math.PI');
        if (isValidExpression(evalStr)) {
            try {
                preview = eval(evalStr);
                if (preview === Infinity) preview = "Tak Terdefinisi";
                else preview = useDeg ? toFraction(preview) : preview.toString();
            } catch {
                preview = "";
            }
        } else {
            preview = "";
        }
    } else {
        preview = "";
    }
    updateDisplay();
}

function handleButton(value) {
    if (value === "C") {
        hasil = "";
        preview = "";
        expressionEl.textContent = "";
    }
    else if (value === "DEL") {
        hasil = hasil.slice(0, -1);
    }
    else if (value === "=") {
        let useDeg = hasil.includes(')');
        let evalStr = hasil
            .replace(/sin\(/g, useDeg ? 'degSin(' : 'Math.sin(')
            .replace(/cos\(/g, useDeg ? 'degCos(' : 'Math.cos(')
            .replace(/tan\(/g, useDeg ? 'degTan(' : 'Math.tan(')
            .replace(/log\(/g, 'Math.log10(')
            .replace(/ln\(/g, 'Math.log(')
            .replace(/√\(/g, 'Math.sqrt(')
            .replace(/\^/g, '**')
            .replace(/π/g, 'Math.PI');
        if (isValidExpression(evalStr)) {
            try {
                const result = eval(evalStr);
                if (result === Infinity) result = "Tak Terdefinisi";
                const resultFormatted = result === "Tak Terdefinisi" ? result : (useDeg ? toFraction(result) : result.toString());
                const riwayat = hasil
                    .replace(/\*/g, '×')
                    .replace(/\//g, '÷')
                    .replace(/degSin\(/g, 'sin(')
                    .replace(/degCos\(/g, 'cos(')
                    .replace(/degTan\(/g, 'tan(')
                    .replace(/Math\.sin\(/g, 'sin(')
                    .replace(/Math\.cos\(/g, 'cos(')
                    .replace(/Math\.tan\(/g, 'tan(')
                    .replace(/Math\.log10\(/g, 'log(')
                    .replace(/Math\.log\(/g, 'ln(')
                    .replace(/Math\.sqrt\(/g, '√(')
                    .replace(/\*\*/g, '^')
                    .replace(/Math\.PI/g, 'π') + " = " + resultFormatted;
                history.push(riwayat);
                localStorage.setItem('history', JSON.stringify(history));
                hasil = resultFormatted.toString();
                preview = "";
                renderHistory();
            } catch {
                hasil = "Tak Terdefinisi";
                preview = "";
            }
        } else {
            hasil = "Error";
            preview = "";
        }
    }
    else {
        hasil += value;
    }

    calculatePreview();
}

document.querySelectorAll('.tombol-container button').forEach(btn => {
    btn.addEventListener('click', () => handleButton(btn.getAttribute('data-value')));
});

document.addEventListener('keydown', (e) => {
    if (e.key === "Enter") { e.preventDefault(); handleButton("="); e.stopPropagation(); }
    if (e.key === "Backspace") { handleButton("DEL"); e.stopPropagation(); }
    if (e.key === "Escape") { handleButton("C"); e.stopPropagation(); }

    if (e.key === "ArrowUp") {
        document.body.classList.add("light");
        localStorage.setItem("themeMode", "light");
        e.stopPropagation();
    }
    if (e.key === "ArrowDown") {
        document.body.classList.remove("light");
        localStorage.setItem("themeMode", "dark");
        e.stopPropagation();
    }
});

function renderHistory() {
    historyListEl.innerHTML = '';

    if (history.length === 0) {
        historyListEl.innerHTML = '<p style="text-align:center; color:#bbb;">Belum ada riwayat</p>';
        hapusAllBtn.style.display = 'none';
    } else {
        history.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'history-item';
            div.innerHTML = `${item} <button class="hapus-btn" data-index="${index}">X</button>`;
            historyListEl.appendChild(div);
        });
        hapusAllBtn.style.display = 'block';
    }
}

historyListEl.addEventListener('click', (e) => {
    if (e.target.classList.contains('hapus-btn')) {
        const index = e.target.getAttribute('data-index');
        history.splice(index, 1);
        localStorage.setItem('history', JSON.stringify(history));
        renderHistory();
    }
});

hapusAllBtn.addEventListener('click', () => {
    history = [];
    localStorage.setItem('history', JSON.stringify(history));
    renderHistory();
});

const range = document.getElementById('kontrasRange');
const persenText = document.getElementById('persenText');

range.addEventListener('input', () => {
    const persen = range.value;
    persenText.textContent = persen + '%';
    const bright = (persen / 100) * 1.8;
    document.documentElement.style.setProperty('--brightness-level', bright);
    localStorage.setItem('brightnessPercent', persen);
});

const savedPercent = localStorage.getItem('brightnessPercent');
if (savedPercent) {
    range.value = savedPercent;
    persenText.textContent = savedPercent + '%';
    const bright = (savedPercent / 100) * 1.8;
    document.documentElement.style.setProperty('--brightness-level', bright);
}

const theme = localStorage.getItem('themeMode');
if (theme === 'light') document.body.classList.add('light');

const toggleThemeBtn = document.getElementById('toggleTheme');
toggleThemeBtn.addEventListener('click', () => {
    document.body.classList.toggle('light');
    const isLight = document.body.classList.contains('light');
    localStorage.setItem('themeMode', isLight ? 'light' : 'dark');
});

renderHistory();
updateDisplay();
</script>



</body>
</html>